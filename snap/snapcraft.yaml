name: rabbitmq-server-snap
base: core18
version: '3.6.10'
summary: AMQP server written in Erlang
description: |
  RabbitMQ is an implementation of AMQP, the emerging standard for
  high performance enterprise messaging. The RabbitMQ server is a
  robust and scalable implementation of an AMQP broker.
icon: assets/logo.png
license: Apache-2.0
architectures:
  - build-on: [amd64, i386, arm64]
grade: stable
confinement: strict

apps:
  rabbitmq-server:
    daemon: simple
    plugs:
      - network
      - network-bind
    restart-condition: on-failure
    restart-delay: 10s
    command: usr/lib/erlang/bin/rabbitmq-server
    stop-command: usr/lib/erlang/bin/rabbitmqctl stop
  rabbitmqctl:
    plugs:
      - network
    command: usr/lib/erlang/bin/rabbitmqctl
  epmd:
    plugs:
      - network
      - network-bind
    command: usr/lib/erlang/bin/epmd
parts:
  rabbitmq-support:
    plugin: dump
    source: assets
    organize:
      rabbitmq-defaults: etc/rabbitmq/rabbitmq-defaults
      rabbitmq-server.service: lib/systemd/system/rabbitmq-server.service
    stage:
     - etc/rabbitmq/rabbitmq-defaults
     - lib/systemd/system/rabbitmq-server.service

  # Building rabbitmq-server from git fails because the build script downloads other
  # repositories in `deps` and uses the `master` branch of them. This leads to build
  # failures because the Erlang version is not recent enough.
  rabbitmq-server:
    after:
      - elixir
      - erlang
    plugin: make
    # source: https://github.com/rabbitmq/rabbitmq-server.git
    # source-tag: rabbitmq_v3_6_10
    source: https://github.com/rabbitmq/rabbitmq-server/releases/download/rabbitmq_v3_6_10/rabbitmq-server_3.6.10.orig.tar.xz
    build-packages:
      - curl
      - python-all
      - python-simplejson
      - rsync
      - unzip
      - xmlto
      - xsltproc
      - zip
    stage-packages:
      - adduser
      - logrotate
      - lsb-base
      - socat
      - libtinfo5
    override-build: |
      set -e -u -x

      # Create branch when checking out from git. Without a branch the build script
      # will fail.
      # git checkout -b buildbranch

      env | sort

      export DESTDIR=${SNAPCRAFT_PART_INSTALL}
      export PREFIX=/usr
      export PYTHON=python3
      export V=1

      sed --in-place \
        --expression 's:^SYS_PREFIX=.*:SYS_PREFIX=${SNAP_COMMON}:' \
        deps/rabbit/scripts/rabbitmq-defaults

      make dist manpages
      
      make install
      make install-bin

      # if ! getent group rabbitmq >/dev/null; then
        # addgroup --system rabbitmq
      # fi

      # create rabbitmq user
      # if ! getent passwd rabbitmq >/dev/null; then
      #   adduser --system \
      #     --ingroup rabbitmq \
      #     --home ${SNAPCRAFT_PART_INSTALL}/var/lib/rabbitmq \
      #     --no-create-home \
      #     --gecos "RabbitMQ messaging server" \
      #     --disabled-login rabbitmq
      # fi

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq
      # chown rabbitmq:rabbitmq /etc/rabbitmq
      if [ -f ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq.conf ] && [ ! -f ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq-env.conf ]; then
        mv ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq.conf ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq-env.conf
        # chown rabbitmq:rabbitmq /etc/rabbitmq/rabbitmq-env.conf
      fi
      if [ -r ${SNAPCRAFT_PART_INSTALL}/usr/share/rabbitmq/rabbitmq-env.conf ] && ! [ -e ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq-env.conf ] ; then
        install -m 0644 -o rabbitmq -g rabbitmq ${SNAPCRAFT_PART_INSTALL}/usr/share/rabbitmq/rabbitmq-env.conf ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/rabbitmq-env.conf
      fi
      if [ -f ${SNAPCRAFT_PART_INSTALL}/etc/rabbitmq/enabled_plugins ] ; then
        chown rabbitmq:rabbitmq /etc/rabbitmq/enabled_plugins
      fi
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/var/lib/rabbitmq/mnesia
      chmod 750 ${SNAPCRAFT_PART_INSTALL}/var/lib/rabbitmq/mnesia
      chmod -R o-rwx,g-w ${SNAPCRAFT_PART_INSTALL}/var/lib/rabbitmq/mnesia
      # chown -R rabbitmq:rabbitmq ${SNAPCRAFT_PART_INSTALL}/var/lib/rabbitmq
      # chown -R rabbitmq:rabbitmq ${SNAPCRAFT_PART_INSTALL}/var/log/rabbitmq

  elixir:
    after:
      - erlang
    plugin: make
    source: https://github.com/elixir-lang/elixir.git
    source-tag: v1.5.3
    override-build: |
      set -e -u -x

      env | sort

      make clean
      make compile
      # make test
      make install PREFIX=/usr DESTDIR=${SNAPCRAFT_PART_INSTALL}
    stage:
      - usr

  erlang:
    plugin: autotools
    source: https://github.com/erlang/otp.git
    source-tag: OTP-20.3.8.26
    build-packages:
      - libssl-dev
      - libncurses-dev
    stage-packages:
      - openssl
      - ncurses-base
      - libncurses5
      - libtinfo5
    override-build: |
      set -e -u -x

      env | sort

      ./otp_build autoconf
      ./configure --prefix=/usr

      make
      make install DESTDIR=${SNAPCRAFT_PART_INSTALL}

      sed --in-place \
        --expression 's:^ROOTDIR.*:ROOTDIR=$(readlink --canonicalize $(dirname $0))/../lib/erlang:' \
        ${SNAPCRAFT_PART_INSTALL}/usr/bin/erl
    stage:
      - usr
